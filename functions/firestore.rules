rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function hasAnyRole(roleList) {
      return isSignedIn() &&
             'roles' in request.auth.token && 
             request.auth.token.roles.hasAny(roleList);
    }

    function managesDepartmentOfNewDoc() {
      return isSignedIn() &&
             'managedDepartments' in request.auth.token &&
             request.auth.token.managedDepartments[request.resource.data.department] == true;
    }
    
    function managesDepartmentOfDoc() {
      return isSignedIn() &&
             'managedDepartments' in request.auth.token &&
             request.auth.token.managedDepartments[resource.data.department] == true;
    }
    
    function isOwnerOfDoc() {
      return request.auth.token.email == resource.data.userId;
    }
    
    function isCreatingForSelf() {
      return request.auth.token.email == request.resource.data.userId;
    }

    // --- Collection Rules ---

    match /configuration/{docId} {
      allow read: if isSignedIn();
      allow write: if hasAnyRole(['Director']);
    }

    match /users/{userEmail} {
      allow read: if isSignedIn();
      allow update: if (isSignedIn() && request.auth.token.email == userEmail) || hasAnyRole(['Director']);
      allow create, delete: if hasAnyRole(['Director', 'HR', 'HR Head', 'RegionalDirector']);

      
      match /documents/{docId} {
        allow read: if (isSignedIn() && request.auth.token.email == userEmail) || hasAnyRole(['Director', 'HR', 'HR Head', 'Finance']) || (request.auth.token.managedDepartments[get(/databases/$(database)/documents/users/$(userEmail)).data.primaryDepartment] == true);
        allow write: if hasAnyRole(['Director', 'HR', 'HR Head', 'Finance']) || (request.auth.token.managedDepartments[get(/databases/$(database)/documents/users/$(userEmail)).data.primaryDepartment] == true);
      }
      match /notifications/{docId} {
        allow read, write: if isSignedIn() && request.auth.token.email == userEmail;
      }
      match /leaveQuotas/{year} {
          allow get: if (isSignedIn() && request.auth.token.email == userEmail) ||
                         hasAnyRole(['Director', 'HR', 'HR Head']) ||
                         (
                           'managedDepartments' in request.auth.token &&
                           request.auth.token.managedDepartments[get(/databases/$(database)/documents/users/$(userEmail)).data.primaryDepartment] == true
                         );
          allow list: if hasAnyRole(['Director', 'HR', 'HR Head']);
          allow write: if (isSignedIn() && request.auth.token.email == userEmail) ||
                           hasAnyRole(['Director', 'HR', 'HR Head']) ||
                           (
                             'managedDepartments' in request.auth.token &&
                             request.auth.token.managedDepartments[get(/databases/$(database)/documents/users/$(userEmail)).data.primaryDepartment] == true
                           );
      }
    }

// --- UPDATED: Scoped Access for Leave Requests ---
    match /requests/{docId} {
      allow get, update, delete: if isSignedIn() && (
        isOwnerOfDoc() || 
        hasAnyRole(['Director', 'HR', 'HR Head']) || 
        (
          // The "Two-Key" Check:
          // 1. Must manage the department
          managesDepartmentOfDoc() && 
          // 2. Must be a role that actually handles people/leave
          hasAnyRole(['DepartmentManager', 'RegionalDirector', 'RespiteManager'])
        )
      );
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isCreatingForSelf();
    }
    
// --- UPDATED: Scoped Access for Claims ---
    match /claims/{docId} {
      allow get, update, delete: if isSignedIn() && (
        isOwnerOfDoc() || 
        hasAnyRole(['Director']) || 
        (
          managesDepartmentOfDoc() && 
          // Only Managers (Approval) or Finance (Processing)
          hasAnyRole(['DepartmentManager', 'RegionalDirector', 'Finance'])
        )
      );
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isCreatingForSelf();
    } 

// --- UPDATED: Scoped Access for Purchase Requests ---
    match /purchaseRequests/{docId} {
      allow get, update, delete: if isSignedIn() && (
        isOwnerOfDoc() || 
        hasAnyRole(['Director']) || 
        (
          managesDepartmentOfDoc() && 
          // Only Managers (Approval) or Purchasers (Processing)
          hasAnyRole(['DepartmentManager', 'RegionalDirector', 'Purchaser'])
        )
      );
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isCreatingForSelf();
    }// --- ADD THIS ENTILE NEW BLOCK ---
    match /paymentRequests/{docId} {
      // A user can see requests they submitted OR requests for departments they manage.
      // Finance/Director can see all.
      allow get: if isSignedIn() && (
          isOwnerOfDoc() ||
          managesDepartmentOfDoc() ||
          hasAnyRole(['Director', 'Finance'])
        );
      
      // Users can query for their own requests, or managers/finance can query for requests.
      allow list: if isSignedIn();
      
      // Allow creation if:
      // 1. The user is a Manager/Director creating for their own department.
      // 2. The user is in Finance (creating on behalf of another department).
      allow create: if isSignedIn() && (
          (isCreatingForSelf() && hasAnyRole(['DepartmentManager', 'RegionalDirector', 'Director'])) ||
          hasAnyRole(['Finance'])
      );
      
      // Allow update if:
      // 1. The user is a Manager of that department (to approve it).
      // 2. The user is in Finance (to mark as paid).
      // 3. The user is a Director.
      allow update: if isSignedIn() && (
          managesDepartmentOfDoc() ||
          hasAnyRole(['Director', 'Finance'])
      );
      
      allow delete: if hasAnyRole(['Director']);
    }
// --- END OF NEW BLOCK ---

// in firestore.rules
  match /supportRequests/{docId} {
    allow create: if isSignedIn() && request.auth.token.email == request.resource.data.requesterId;

    // --- START: NEW COMPREHENSIVE RULE ---
    allow get, update, delete: if isSignedIn() && 
      (
        // The creator can access it
        request.auth.token.email == resource.data.requesterId ||
        // The person it is assigned to can access it
        request.auth.token.email == resource.data.assigneeId ||
        // Director and IT have global access
        hasAnyRole(['Director', 'IT']) ||
        // ANY manager of the requester's department can access it
        (
          'managedDepartments' in request.auth.token &&
          request.auth.token.managedDepartments[resource.data.department] == true
        )
      );
    // --- END: NEW COMPREHENSIVE RULE ---

    allow list: if isSignedIn();
  }
    match /attendance/{docId} {
      allow get: if isSignedIn() && (isOwnerOfDoc() || hasAnyRole(['Director', 'HR', 'HR Head']) || managesDepartmentOfDoc());
      allow list: if isSignedIn();
      allow create: if isSignedIn() && (isCreatingForSelf() || hasAnyRole(['Director', 'HR', 'HR Head']) || managesDepartmentOfNewDoc());
      // FIXED: Removed stray comma from the end of the hasAnyRole list
      allow update, delete: if isSignedIn() && (isOwnerOfDoc() || hasAnyRole(['Director', 'HR', 'HR Head']) || managesDepartmentOfDoc());
    }

    match /attendanceExceptions/{docId} {
      allow create: if false; // Only allowed via Cloud Functions (Admin SDK)
      allow get: if isSignedIn() && (isOwnerOfDoc() || hasAnyRole(['Director', 'HR', 'HR Head']) || managesDepartmentOfDoc());
      allow list: if isSignedIn();
      allow update: if (hasAnyRole(['Director', 'HR', 'HR Head']) || managesDepartmentOfDoc()) || (isOwnerOfDoc() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['acknowledged']));
    }
    
// in firestore.rules

    match /announcements/{announcementId} {
      allow read, list: if isSignedIn();

      // --- START: CORRECTED CREATE RULE ---
      allow create: if isSignedIn() &&
        (
          // Rule 1: Allow if user is a Director.
          hasAnyRole(['Director']) ||
          // Rule 2: OR allow if user is a Scoped Announcer.
          (
            // The user must be a manager of some kind.
            hasAnyRole(['DepartmentManager', 'RegionalDirector', 'HR', 'HR Head', 'Finance', 'Purchaser', 'Admin', 'RespiteManager']) &&
            // CORRECTED LINE: This now correctly checks if the '__ALL__' value is NOT in the list.
            !request.resource.data.targetDepartments.hasAny(['__ALL__']) &&
            // And all departments they are trying to send to must exist in their list of managed departments.
            request.resource.data.targetDepartments.removeAll(request.auth.token.managedDepartments.keys()).size() == 0
          )
        );
      // --- END: CORRECTED CREATE RULE ---

      allow update, delete: if isSignedIn() && (resource.data.creatorId == request.auth.token.email || hasAnyRole(['Director']));

match /acknowledgements/{userEmail} {
        allow get: if isSignedIn() && request.auth.token.email == userEmail;
        // CORRECTED RULE: Added Finance and Purchaser to the list of roles.
        allow list: if hasAnyRole(['Director', 'HR', 'HR Head', 'DepartmentManager', 'RegionalDirector', 'Admin', 'Finance', 'Purchaser']);
        allow create: if isSignedIn() && request.auth.token.email == userEmail;
        allow update, delete: if false;
      }
    }

    match /userAlerts/{alertId} {
      // A user can read or query for their own alerts.
      allow read: if isSignedIn() && request.auth.token.email == resource.data.userId;
      
      // A user can only update the 'acknowledged' field of their own alert.
      allow update: if isSignedIn() && request.auth.token.email == resource.data.userId &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['acknowledged']);
      
      // No one can create or delete alerts from the client side.
      allow create, delete: if false;
    }

    match /companyCalendar/{date} {
      allow read: if isSignedIn();
      
      allow create, update: if (
        hasAnyRole(['Director', 'Admin'])
      ) || (
        hasAnyRole(['HR', 'HR Head', 'RegionalDirector']) &&
        !request.resource.data.appliesTo.hasAny(['__ALL__']) &&
        request.resource.data.appliesTo.removeAll(request.auth.token.managedDepartments.keys()).size() == 0
      );

      allow delete: if
        hasAnyRole(['Director', 'Admin']) ||
        (
          hasAnyRole(['HR', 'HR Head', 'RegionalDirector']) &&
          resource.data.appliesTo.removeAll(request.auth.token.managedDepartments.keys()).size() == 0
        );
    }
  }
}